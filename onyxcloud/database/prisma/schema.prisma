generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum SubscriptionStatus {
  active
  overdue
  suspended
  cancelled
}

enum InvoiceStatus {
  pending
  paid
  failed
  refunded
}

enum ServerStatus {
  provisioning
  running
  stopped
  suspended
  terminated
  failed
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  users       User[]
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}

model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  password_hash      String
  full_name          String
  is_verified        Boolean             @default(false)
  totp_secret        String?
  pterodactyl_user_id Int?
  role_id            String
  role               Role                @relation(fields: [role_id], references: [id])
  sessions           Session[]
  email_verifications EmailVerification[]
  password_resets    PasswordReset[]
  subscriptions      Subscription[]
  invoices           Invoice[]
  payments           Payment[]
  servers            Server[]
  admin_logs         AdminLog[]
  created_at         DateTime            @default(now())
  updated_at         DateTime            @updatedAt
  @@index([role_id])
}

model Session {
  id            String   @id @default(cuid())
  user_id       String
  user          User     @relation(fields: [user_id], references: [id])
  token         String   @unique
  remember_me   Boolean  @default(false)
  ip_address    String
  user_agent    String?
  expires_at    DateTime
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  @@index([user_id])
}

model EmailVerification {
  id          String   @id @default(cuid())
  user_id     String
  user        User     @relation(fields: [user_id], references: [id])
  token       String   @unique
  expires_at  DateTime
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}

model PasswordReset {
  id          String   @id @default(cuid())
  user_id     String
  user        User     @relation(fields: [user_id], references: [id])
  token       String   @unique
  expires_at  DateTime
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}

model Plan {
  id                 String   @id @default(cuid())
  name               String
  product_type       String
  price_paise        Int
  currency           String   @default("INR")
  cpu_limit          Int
  memory_mb          Int
  disk_mb            Int
  grace_period_days  Int      @default(3)
  subscriptions      Subscription[]
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
}

model Subscription {
  id                 String             @id @default(cuid())
  user_id            String
  plan_id            String
  user               User               @relation(fields: [user_id], references: [id])
  plan               Plan               @relation(fields: [plan_id], references: [id])
  status             SubscriptionStatus @default(active)
  next_billing_date  DateTime
  grace_period_days  Int
  servers            Server[]
  invoices           Invoice[]
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
  @@index([user_id, status])
}

model Invoice {
  id               String      @id @default(cuid())
  user_id          String
  subscription_id  String
  amount_paise     Int
  status           InvoiceStatus @default(pending)
  due_date         DateTime
  qr_payload       String
  user             User        @relation(fields: [user_id], references: [id])
  subscription     Subscription @relation(fields: [subscription_id], references: [id])
  payments         Payment[]
  transactions     Transaction[]
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
  @@index([subscription_id, status])
}

model Payment {
  id               String      @id @default(cuid())
  user_id          String
  invoice_id       String
  amount_paise     Int
  gateway_ref      String      @unique
  status           InvoiceStatus
  verified_at      DateTime?
  user             User        @relation(fields: [user_id], references: [id])
  invoice          Invoice     @relation(fields: [invoice_id], references: [id])
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
}

model Transaction {
  id               String   @id @default(cuid())
  invoice_id       String
  txn_ref          String   @unique
  payload          Json
  invoice          Invoice  @relation(fields: [invoice_id], references: [id])
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt
}

model Location {
  id           String   @id @default(cuid())
  name         String
  region       String
  nodes        Node[]
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
}

model Node {
  id            String   @id @default(cuid())
  pterodactyl_node_id Int @unique
  name          String
  location_id   String
  location      Location @relation(fields: [location_id], references: [id])
  allocations   Allocation[]
  servers       Server[]
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
}

model Egg {
  id            String   @id @default(cuid())
  pterodactyl_egg_id Int @unique
  name          String
  docker_image  String
  servers       Server[]
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
}

model Allocation {
  id             String   @id @default(cuid())
  node_id        String
  ip             String
  port           Int
  is_assigned    Boolean  @default(false)
  node           Node     @relation(fields: [node_id], references: [id])
  servers        Server[]
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  @@unique([node_id, ip, port])
}

model Server {
  id                 String      @id @default(cuid())
  user_id            String
  subscription_id    String
  node_id            String
  egg_id             String
  allocation_id      String
  pterodactyl_server_id String?   @unique
  name               String
  status             ServerStatus @default(provisioning)
  user               User        @relation(fields: [user_id], references: [id])
  subscription       Subscription @relation(fields: [subscription_id], references: [id])
  node               Node        @relation(fields: [node_id], references: [id])
  egg                Egg         @relation(fields: [egg_id], references: [id])
  allocation         Allocation  @relation(fields: [allocation_id], references: [id])
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
}

model AdminLog {
  id            String   @id @default(cuid())
  user_id       String
  action        String
  metadata      Json
  user          User     @relation(fields: [user_id], references: [id])
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
}

model SystemSetting {
  id            String   @id @default(cuid())
  key           String   @unique
  value         String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
}
